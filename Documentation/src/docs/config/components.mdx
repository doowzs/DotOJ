# 模块介绍

问题求解OJ的程序主要由以下模块组成：

- WebApp：提供数据交互API和用户所使用的Web Application程序
- Worker：负责评测代码、查重的程序
- MariaDB：负责存储数据的关系型数据库（即MySQL）
- RabbitMQ：负责在API和评测程序之间转发、存储消息的消息队列

## WebApp

WebApp模块的作用有两个：负责提供API和网页程序。

问题求解OJ的绝大部分页面都是运行在用户浏览器上的，由JavaScript通过XMLHttpRequest向服务器请求数据并展示给用户。
用户第一次访问问题求解OJ，就会加载一个用Angular框架编写而成的应用程序，然后向服务器请求时间、作业等信息并展示。
只有用户在登陆、修改密码等设置时，这部分的页面才是由服务器提供的。

如果WebApp被关闭或因为错误而退出，Worker依然能够直接与消息队列通信，继续完成已经收到的提交的评测。
如果由于某些原因需要暂时关闭对问题求解OJ的访问，只需要关闭WebApp就可以了。

## Worker

Worker模块的作用也有两个：负责对代码进行测评和查重。

在早先的设计中，Worker会对数据库进行轮询，查找没有评测的代码。
现在的实现中，Worker只有接收到消息队列中的消息，才会去评测代码，最小化服务器的负担。

Worker能够与数据库进行通信，获取并更新提交信息，但评测代码的数据和查重结果都是存储在文件系统中的，
因此Worker必须与WebApp共享同一个文件系统（该文件系统即便是NFS也OK），才能正常读取、存储数据。

Worker的编号是由Docker决定的，由于`docker-compose`的限制，批量运行某一容器时必须使用相同的配置，
因此无法通过不同的配置文件给不同的评测机分别编号。而Docker在运行容器时会分配给每一个容器一个不同的内网IP，
故设计Worker根据该IP地址的最后一段确定其编号，不建议对此行为作出修改。

如果Worker在运行中被关闭或因为错误而退出，下次启动时会向WebApp发出消息，以确保所有代码都能正常评测。
（说实话这个实现对不对zty是没有信心的，关闭Worker本身就是一个gently closing up的过程，会阻塞到评测任务结束；
他也没有直接杀死过进程，更何况就算直接杀死进程也没有那么倒霉正好在评测，所以可能只是因为概率过低没有出错。）
